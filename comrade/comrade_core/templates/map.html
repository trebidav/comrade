<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map - Comrade</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB6UjXEjOGGxVwUFB2lHGNk2u0_NfJZSBg"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .user-info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .user-info p {
            margin: 5px 0;
            color: #666;
        }
        .logout-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .logout-button:hover {
            background: #c82333;
        }
        .legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .legend-text {
            color: #666;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="user-info">
        <h3>Logged in as:</h3>
        <p id="user-name">Loading...</p>
        <p id="user-email">Loading...</p>
        <button class="logout-button" onclick="window.location.href='/accounts/logout/'">Logout</button>
    </div>
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #4285F4;"></div>
            <span class="legend-text">Your Location</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #34A853;"></div>
            <span class="legend-text">Friends</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FBBC05;"></div>
            <span class="legend-text">Public Shares</span>
        </div>
    </div>

    <script>
        // Get API token and user info from context
        const apiToken = '{{ api_token }}';
        const userInfo = JSON.parse('{{ user|safe }}');

        // Store in localStorage for future use
        localStorage.setItem('api_token', apiToken);
        localStorage.setItem('user_info', JSON.stringify(userInfo));

        // Display user info
        document.getElementById('user-name').textContent = userInfo.name;
        document.getElementById('user-email').textContent = userInfo.email;

        // Initialize map
        let map;
        let userMarker;
        let accuracyCircle;
        let friendsMarkers = {};
        let publicMarkers = {};

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 50.0755, lng: 14.4378 }, // Prague
                zoom: 13,
            });

            // Initialize WebSocket connection
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws/location/?token=${apiToken}`);

            ws.onopen = function() {
                console.log('WebSocket connection established');
                // Start sending location updates
                if (navigator.geolocation) {
                    // First, get initial position
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            updateUserLocation({
                                coords: {
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    accuracy: position.coords.accuracy
                                }
                            });
                        },
                        function(error) {
                            console.error('Error getting initial location:', error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );

                    // Then, watch for position changes
                    navigator.geolocation.watchPosition(
                        function(position) {
                            updateUserLocation({
                                coords: {
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    accuracy: position.coords.accuracy
                                }
                            });
                            
                            // Send location to server
                            const location = {
                                type: 'location_update',
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                userId: userInfo.id,
                                name: userInfo.name
                            };
                            
                            if (ws.readyState === WebSocket.OPEN) {
                                ws.send(JSON.stringify(location));
                            }
                        },
                        function(error) {
                            console.error('Error watching location:', error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                }
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'location_update') {
                    updateUserLocation({
                        coords: {
                            latitude: data.latitude,
                            longitude: data.longitude,
                            accuracy: data.accuracy || 50
                        }
                    });
                } else if (data.type === 'friend_location') {
                    updateFriendLocation(data);
                } else if (data.type === 'public_location') {
                    updatePublicLocation(data);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed');
            };
        }

        function updateUserLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            // Update or create marker
            if (!userMarker) {
                userMarker = new google.maps.Marker({
                    position: { lat, lng },
                    map: map,
                    title: 'Your Location',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2,
                    }
                });
            } else {
                userMarker.setPosition({ lat, lng });
            }

            // Update or create accuracy circle
            if (!accuracyCircle) {
                accuracyCircle = new google.maps.Circle({
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.2,
                    strokeWeight: 1,
                    fillColor: '#4285F4',
                    fillOpacity: 0.1,
                    map: map,
                    center: { lat, lng },
                    radius: accuracy
                });
            } else {
                accuracyCircle.setCenter({ lat, lng });
                accuracyCircle.setRadius(accuracy);
            }

            // Center map on user's location
            map.setCenter({ lat, lng });
            map.setZoom(15); // Zoom level for street view
        }

        function updateFriendLocation(data) {
            const { userId, latitude, longitude, name } = data;
            
            // Create or update marker
            if (!friendsMarkers[userId]) {
                const marker = new google.maps.Marker({
                    position: { lat: latitude, lng: longitude },
                    map: map,
                    title: name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#34A853',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2,
                    }
                });

                // Add info window
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div><strong>${name}</strong></div>`
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                friendsMarkers[userId] = marker;
            } else {
                const marker = friendsMarkers[userId];
                marker.setPosition({ lat: latitude, lng: longitude });
            }
        }

        function updatePublicLocation(data) {
            const { userId, latitude, longitude, name } = data;
            
            // Create or update marker
            if (!publicMarkers[userId]) {
                const marker = new google.maps.Marker({
                    position: { lat: latitude, lng: longitude },
                    map: map,
                    title: name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#FBBC05',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2,
                    }
                });

                // Add info window
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div><strong>${name}</strong></div>`
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                publicMarkers[userId] = marker;
            } else {
                const marker = publicMarkers[userId];
                marker.setPosition({ lat: latitude, lng: longitude });
            }
        }

        // Initial WebSocket connection
        initMap();
    </script>
</body>
</html>